<!DOCTYPE html>
<html class="no-js" lang="pt">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>SeguranÃ§a em camadas com SystemD - Leandro PeÃ§anha Scardua</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		
		<meta property="og:title" content="SeguranÃ§a em camadas com SystemD" />
<meta property="og:description" content="Existe um aspecto muito pouco conhecido do SystemD que Ã© a capacidade de obter dados estruturados para diagnosticar problemas.
A ferramenta systemd-analyze Ã© muito pouco conhecida e, de sua potencialidade total, muito pouco Ã© efetivamente usado.
AlÃ©m de permitir diagnosticar problemas relacionados Ã  inicializaÃ§Ã£o do sistema, o SystemD fornece mecanismos para avaliar e corrigir
a (in)seguranÃ§a dos serviÃ§os(daemons) executando sob ele, criando uma camada de proteÃ§Ã£o." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://leandropecanhascardua.github.io/artigos/systemd-security/" />
<meta property="article:published_time" content="2022-10-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-10-02T00:00:00+00:00" />

		<meta itemprop="name" content="SeguranÃ§a em camadas com SystemD">
<meta itemprop="description" content="Existe um aspecto muito pouco conhecido do SystemD que Ã© a capacidade de obter dados estruturados para diagnosticar problemas.
A ferramenta systemd-analyze Ã© muito pouco conhecida e, de sua potencialidade total, muito pouco Ã© efetivamente usado.
AlÃ©m de permitir diagnosticar problemas relacionados Ã  inicializaÃ§Ã£o do sistema, o SystemD fornece mecanismos para avaliar e corrigir
a (in)seguranÃ§a dos serviÃ§os(daemons) executando sob ele, criando uma camada de proteÃ§Ã£o.">
<meta itemprop="datePublished" content="2022-10-02T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-10-02T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3446">



<meta itemprop="keywords" content="ubuntu,linux,systemD," />
		
		<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SeguranÃ§a em camadas com SystemD"/>
<meta name="twitter:description" content="Existe um aspecto muito pouco conhecido do SystemD que Ã© a capacidade de obter dados estruturados para diagnosticar problemas.
A ferramenta systemd-analyze Ã© muito pouco conhecida e, de sua potencialidade total, muito pouco Ã© efetivamente usado.
AlÃ©m de permitir diagnosticar problemas relacionados Ã  inicializaÃ§Ã£o do sistema, o SystemD fornece mecanismos para avaliar e corrigir
a (in)seguranÃ§a dos serviÃ§os(daemons) executando sob ele, criando uma camada de proteÃ§Ã£o."/>


	<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/custom.css">

	<link rel="shortcut icon" href="https://leandropecanhascardua.github.io/favicon.ico">

	
		
	 <link rel="stylesheet" href="/post.css">
</head>
<body class="body">
	<header class="header">
	
	<div class="logo logo--mixed">
		<div class="container">
			<a class="logo__link" href="/" title="Leandro PeÃ§anha Scardua" rel="home">
				<div class="logo__item logo__imagebox">
						<img class="logo__img" src="/img/rei-leao.png" alt="Logo image">
					</div><div class="logo__item logo__text">
						<div class="logo__title">Leandro PeÃ§anha Scardua</div>
						<div class="logo__tagline">Tecnologia e Desenvolvimento de sistemas</div>
					</div>
			</a>
		</div>
	</div>

</header>

<nav class="menu">
	<div class="container">
		<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
			<span class="menu__btn-title" tabindex="-1">Menu</span>
		</button>
		<ul class="menu__list">
			<li class="menu__item">
				<a class="menu__link" href="/">
					
					<span class="menu__text">Home</span>
					
				</a>
			</li>
			<li class="menu__item">
				<a class="menu__link" href="/artigos/">
					
					<span class="menu__text">Artigos</span>
					
				</a>
			</li>
			<li class="menu__item">
				<a class="menu__link" href="/dicas/">
					
					<span class="menu__text">Dicas</span>
					
				</a>
			</li>
		</ul>
	</div>
</nav>



	<div class="container wrapper flex">
		<div class="primary">
		
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SeguranÃ§a em camadas com SystemD</h1>
			<div class="post__meta meta"><div class="meta__item-author meta__item">
	<svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2 0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class="meta__text">Leandro PeÃ§anha Scardua</span>
</div>
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2022-10-02T00:00:00Z">02.10.2022</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/linux/" rel="category">Linux</a>, <a class="meta__link" href="/categories/artigos/" rel="category">Artigos</a>
	</span>
</div></div>
		</header><div class="content post__content clearfix">
			<p>Existe um aspecto muito pouco conhecido do SystemD que Ã© a capacidade de obter dados estruturados para diagnosticar problemas.</p>
<p>A ferramenta systemd-analyze Ã© muito pouco conhecida e, de sua potencialidade total, muito pouco Ã© efetivamente usado.</p>
<p>AlÃ©m de permitir diagnosticar problemas relacionados Ã  inicializaÃ§Ã£o do sistema, o SystemD fornece mecanismos para avaliar e corrigir
a (in)seguranÃ§a dos serviÃ§os(daemons) executando sob ele, criando uma camada de proteÃ§Ã£o.</p>
<p>A primeira camada de proteÃ§Ã£o Ã© feita pelo prÃ³prio serviÃ§o ou aplicaÃ§Ã£o. Sua configuraÃ§Ã£o e codificaÃ§Ã£o.</p>
<p>Se um atacante explorar uma falha, Ã© importante que possamos limitar ao mÃ¡ximo o estrago que ele possa fazer restringindo os recursos
disponÃ­veis.</p>
<p>Eu jÃ¡ analizei o systemd-analyze em outro artigo sobre <a href="/dicas/procurando-erros-no-linux_01/">como descobrir erros no Linux</a>.</p>
<p>Ã‰ uma excelente ferramenta, mas alÃ©m da capacidade de diagnosticar problemas relacionados aos serviÃ§os durante a inicializaÃ§Ã£o,
esse comando tambÃ©m permite avaliar a seguranÃ§a de acordo com um checklist de itens!</p>
<p>Rodando <strong>systemd-analyze security</strong> podemos fazer uma auditoria de todos os serviÃ§os.</p>
<blockquote>
<p>leandro@leandro:~$ <strong>systemd-analyze security</strong><br>
UNIT                                  EXPOSURE PREDICATE HAPPY<br>
Â ModemManager.service Â Â Â Â Â Â  5.8 MEDIUM    ğŸ˜ <br>
Â NetworkManager.service Â Â Â Â  7.8 EXPOSED   ğŸ™ <br>
Â accounts-daemon.service Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â acpid.service Â Â Â Â Â Â  Â Â Â Â Â Â Â 9.6 UNSAFE    ğŸ˜¨ <br>
Â alsa-state.service Â Â Â Â Â Â  Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â anacron.service Â Â Â Â Â Â  Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â apport.service Â Â Â Â Â Â  Â Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â avahi-daemon.service Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â cron.service Â Â Â Â Â Â  Â Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â cups-browsed.service Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â cups.service Â Â Â Â Â Â  Â Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â dbus.service Â Â Â Â Â Â  Â Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â dmesg.service Â Â Â Â Â Â  Â Â Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â emergency.service  Â Â Â Â Â Â  Â Â   9.5 UNSAFE    ğŸ˜¨ <br>
Â getty@tty1.service Â Â Â Â Â Â  Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â getty@tty7.service Â Â Â Â Â Â  Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â hddtemp.service Â Â Â Â Â Â  Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â irqbalance.service Â Â Â Â Â Â  Â  6.1 MEDIUM    ğŸ˜ <br>
Â kerneloops.service Â Â Â Â Â Â  Â  9.2 UNSAFE    ğŸ˜¨ <br>
Â lightdm.service Â Â Â Â Â Â  Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â ondemand.service Â Â Â Â Â Â  Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â plymouth-start.service Â Â Â Â   9.5 UNSAFE    ğŸ˜¨ <br>
Â polkit.service Â Â Â Â Â Â  Â Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â rc-local.service Â Â Â Â Â Â  Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â rescue.serviceÂ Â Â Â Â Â  Â Â Â Â Â Â  9.5 UNSAFE    ğŸ˜¨ <br>
Â rsync.service Â Â Â Â Â Â  Â Â Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â rsyslog.service Â Â Â Â Â Â  Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â rtkit-daemon.service Â Â Â Â Â Â   7.1 MEDIUM    ğŸ˜ <br>
Â smartmontools.service Â Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â systemd-ask-password-console.service Â Â Â Â Â  9.3 UNSAFE    ğŸ˜¨ <br>
Â systemd-ask-password-plymouth.service Â Â Â Â Â 9.5 UNSAFE    ğŸ˜¨ <br>
Â systemd-ask-password-wall.service Â Â Â Â Â Â  Â  9.4 UNSAFE    ğŸ˜¨ <br>
Â systemd-fsckd.service Â Â Â Â Â  9.5 UNSAFE    ğŸ˜¨ <br>
Â systemd-initctl.service Â Â Â  9.3 UNSAFE    ğŸ˜¨ <br>
Â systemd-journald.service Â Â  4.4 OK        ğŸ™‚ <br>
Â systemd-logind.service Â Â Â Â  2.8 OK        ğŸ™‚ <br>
Â systemd-networkd.service Â Â  3.1 OK        ğŸ™‚ <br>
Â systemd-resolved.service Â Â   2.2 OK        ğŸ™‚ <br>
Â systemd-rfkill.service Â Â Â Â   9.3 UNSAFE    ğŸ˜¨ <br>
Â systemd-timesyncd.service Â  2.1 OK        ğŸ™‚ <br>
Â systemd-udevd.service Â Â Â Â Â  8.4 EXPOSED   ğŸ™ <br>
Â thermald.service Â Â Â Â Â Â Â Â Â Â  9.6 UNSAFE    ğŸ˜¨ <br>
Â udisks2.service Â Â Â Â Â Â  Â Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â unattended-upgrades.service 9.6 UNSAFE    ğŸ˜¨ <br>
Â upower.service Â Â Â Â Â Â  Â Â Â Â Â   2.3 OK        ğŸ™‚ <br>
Â user@1000.service  Â Â Â Â Â Â  Â Â Â 9.4 UNSAFE    ğŸ˜¨ <br>
Â uuidd.service Â Â Â Â Â Â  Â Â Â Â Â Â   4.5 OK        ğŸ™‚ <br>
Â whoopsie.service Â Â Â Â Â Â  Â Â Â   9.6 UNSAFE    ğŸ˜¨ <br>
Â wpa_supplicant.service Â Â Â Â  9.6 UNSAFE    ğŸ˜¨</p>
</blockquote>
<p>Obtemos um relatÃ³rio como acima, dividido em 04 colunas, todas fornecendo a mesma informaÃ§Ã£o, mas em um formato diferente.</p>
<p>Na primeira coluna temos o nome da <strong>Unit</strong>; na segunda coluna temos o grau de exposiÃ§Ã£o, que Ã© uma mÃ©trica calculada verificando
se as configuraÃ§Ãµes do serviÃ§o estÃ£o de acordo com um checklist de seguranÃ§a; a terceira coluna traduz o valor do grau de
exposiÃ§Ã£o em forma verbal, onde podemos ter avaliaÃ§Ãµes como <strong>UNSAFE</strong>, <strong>OK</strong>, <strong>EXPOSED</strong>, <strong>MEDIUM</strong>; o Ãºltimo campo facilita ainda
mais a compreensÃ£o ao traduzir o grau de exposiÃ§Ã£o em forma pictÃ³rica, isto Ã©, em um emoji, onde podemos ter uma carinha feliz quando
o serviÃ§o estÃ¡ protegido e uma carinha triste quando o serviÃ§o estÃ¡ exposto.</p>
<p>Ã‰ importante mencionar que o grau de exposiÃ§Ã£o varia entre 0 e 10, sendo 0(zero) considerado o mais seguro possÃ­vel
e 10(dez) o mais inseguro possÃ­vel considerando os itens da checklist de verificaÃ§Ãµes que o systemd-analyze vai analisar.</p>
<p>Ou seja, o Systemd pretende fazer a seguranÃ§a do sistema mensurÃ¡vel e demonstrÃ¡vel!!!! Esse paradigma Ã© herdado da filosofia da ciÃªncia,
onde sÃ³ pode ser melhorado aquilo que pode ser medido!</p>
<p>Nosso relatÃ³rio acima mostra que alguns serviÃ§os estÃ£o com nÃ­vel aceitÃ¡vel de seguranÃ§a, como o <strong>systemd-logind</strong>. Outros, como
o <strong>cups-browsed</strong> estÃ£o com um nÃ­vel preocupante.</p>
<p>AlÃ©m disso, o systemd-analyze pode mostrar como ele chegou a essa avaliaÃ§Ã£o, isto Ã©, quais critÃ©rios ele usou para chegar a este valor
e como calculou a avaliaÃ§Ã£o final. Para isso, basta rodar o comando novamente passando o nome da <strong>Unit</strong> como segundo argumento e poderemos
ver os itens de checklist de seguranÃ§a para este serviÃ§o(daemon):</p>
<blockquote>
<p>leandro@leandro:~$ <strong>systemd-analyze security cups &ndash;no-pager</strong><br>
Â <strong>NAME</strong>                                                        <strong>DESCRIPTION</strong>                                                            <strong>EXPOSURE</strong><br>
âœ— PrivateNetwork=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has access to the host&rsquo;s network                                     0.5<br>
âœ— User=/DynamicUser=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Service runs as root user                                                    0.4<br>
âœ— CapabilityBoundingSet=~CAP_SET(UID|GID|PCAP)Â Service may change UID/GID identities/capabilities                           0.3<br>
âœ— CapabilityBoundingSet=~CAP_SYS_ADMINÂ Â Â Â Â Â Â Â Â Service has administrator privileges                                         0.3<br>
âœ— CapabilityBoundingSet=~CAP_SYS_PTRACEÂ Â Â Â Â Â Â Â Service has ptrace() debugging abilities                                     0.3<br>
âœ— RestrictAddressFamilies=~AF_(INET|INET6)Â Â Â Â  Service may allocate Internet sockets                                        0.3<br>
âœ— RestrictNamespaces=~CLONE_NEWUSERÂ Â Â Â Â Â Â Â Â Â Â Â Service may create user namespaces                                           0.3<br>
âœ— RestrictAddressFamilies=~â€¦ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may allocate exotic sockets                                          0.3<br>
âœ— CapabilityBoundingSet=~CAP_(CHOWN|FSETID|SETFCAP) Â Â Â Â Â Â Service may change file ownership/access mode/capabilities unrestricted      0.2<br>
âœ— CapabilityBoundingSet=~CAP_(DAC_*|FOWNER|IPC_OWNER)Â Â Â Â  Service may override UNIX file/IPC permission checks                         0.2<br>
âœ— CapabilityBoundingSet=~CAP_NET_ADMIN Â Â Â Â Â Â Â  Service has network configuration privileges                                 0.2<br>
âœ— CapabilityBoundingSet=~CAP_RAWIO Â Â Â Â Â Â Â Â Â Â Â  Service has raw I/O access                                                   0.2<br>
âœ— CapabilityBoundingSet=~CAP_SYS_MODULE Â Â Â Â Â Â  Service may load kernel modules                                              0.2<br>
âœ— CapabilityBoundingSet=~CAP_SYS_TIMEÂ Â Â Â Â Â Â Â Â  Service processes may change the system clock                                0.2<br>
âœ— DeviceAllow=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  Service has no device ACL                                                    0.2<br>
âœ— IPAddressDeny=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not define an IP address whitelist                              0.2<br>
âœ“ KeyringMode=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service doesn&rsquo;t share key material with other services                       <br>
âœ— NoNewPrivileges=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service processes may acquire new privileges                                 0.2<br>
âœ“ NotifyAccess=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service child processes cannot alter service state                           <br>
âœ— PrivateDevices=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service potentially has access to hardware devices                           0.2<br>
âœ— PrivateMounts=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may install system mounts                                            0.2<br>
âœ— PrivateTmp=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has access to other software&rsquo;s temporary files                       0.2<br>
âœ— PrivateUsers=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has access to other users                                            0.2<br>
âœ— ProtectClock=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may write to the hardware clock or system clock                      0.2<br>
âœ— ProtectControlGroups=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may modify the control group file system                             0.2<br>
âœ— ProtectHome=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has full access to home directories                                  0.2<br>
âœ— ProtectKernelLogs=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may read from or write to the kernel log ring buffer                 0.2<br>
âœ— ProtectKernelModules=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may load or read kernel modules                                      0.2<br>
âœ— ProtectKernelTunables=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may alter kernel tunables                                            0.2<br>
âœ— ProtectSystem=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service has full access to the OS file hierarchy                             0.2<br>
âœ— RestrictAddressFamilies=~AF_PACKETÂ Â Â Â Â Â Â Â Â Â Â Service may allocate packet sockets                                          0.2<br>
âœ— RestrictSUIDSGID=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may create SUID/SGID files                                           0.2<br>
âœ— SystemCallArchitectures=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may execute system calls with all ABIs                               0.2<br>
âœ— SystemCallFilter=~@clockÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@debugÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@moduleÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@mountÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@raw-ioÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@rebootÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@swapÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@privilegedÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ— SystemCallFilter=~@resourcesÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.2<br>
âœ“ AmbientCapabilities=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service process does not receive ambient capabilities                         <br>
âœ— CapabilityBoundingSet=~CAP_AUDIT_*Â Â Â Â Â Â Â Â Â Â Â Service has audit subsystem access                                           0.1<br>
âœ— CapabilityBoundingSet=~CAP_KILLÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Service may send UNIX signals to arbitrary processes                         0.1<br>
âœ— CapabilityBoundingSet=~CAP_MKNODÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create device nodes                                              0.1<br>
âœ— CapabilityBoundingSet=~CAP_NET_(BIND_SERVICE|BROADCAST|RAW)Â Â Â Â Â Â  Service has elevated networking privileges                                   0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYSLOGÂ Â Â Â Â Â Â Â Â Â Â Â Service has access to kernel logging                                         0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYS_(NICE|RESOURCE) Â Â Â Â Â Â  Service has privileges to change resource use parameters                     0.1<br>
âœ— RestrictNamespaces=~CLONE_NEWCGROUPÂ Â Â Â Â Â Â Â Â Â Service may create cgroup namespaces                                         0.1<br>
âœ— RestrictNamespaces=~CLONE_NEWIPCÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create IPC namespaces                                            0.1<br>
âœ— RestrictNamespaces=~CLONE_NEWNETÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create network namespaces                                        0.1<br>
âœ— RestrictNamespaces=~CLONE_NEWNSÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Service may create file system namespaces                                    0.1<br>
âœ— RestrictNamespaces=~CLONE_NEWPIDÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create process namespaces                                        0.1<br>
âœ— RestrictRealtime=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may acquire realtime scheduling                                      0.1<br>
âœ— SystemCallFilter=~@cpu-emulationÂ Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.1<br>
âœ— SystemCallFilter=~@obsoleteÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not filter system calls                                         0.1<br>
âœ— RestrictAddressFamilies=~AF_NETLINKÂ Â Â Â Â Â Â Â Â Â Service may allocate netlink sockets                                         0.1<br>
âœ— RootDirectory=/RootImage=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service runs within the host&rsquo;s root directory                                0.1<br>
SupplementaryGroups=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service runs as root, option does not matter                                   <br>
âœ— CapabilityBoundingSet=~CAP_MAC_*Â Â Â Â Â Â Â Â Â Â Â Â Â Service may adjust SMACK MAC                                                 0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYS_BOOTÂ Â Â Â Â Â Â Â Â Â Service may issue reboot()                                                   0.1<br>
âœ“ Delegate=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service does not maintain its own delegated control group subtree              <br>
âœ— LockPersonality=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may change ABI personality                                           0.1<br>
âœ— MemoryDenyWriteExecute=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may create writable executable memory mappings                       0.1<br>
RemoveIPC=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service runs as root, option does not apply                                   <br>
âœ— RestrictNamespaces=~CLONE_NEWUTSÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create hostname namespaces                                       0.1<br>
âœ— UMask=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Files created by service are world-readable by default                       0.1<br>
âœ— CapabilityBoundingSet=~CAP_LINUX_IMMUTABLEÂ Â Â Service may mark files immutable                                             0.1<br>
âœ— CapabilityBoundingSet=~CAP_IPC_LOCKÂ Â Â Â Â Â Â Â Â Â Service may lock memory into RAM                                             0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYS_CHROOTÂ Â Â Â Â Â Â Â Service may issue chroot()                                                   0.1<br>
âœ— ProtectHostname=Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Service may change system host/domainname                                    0.1<br>
âœ— CapabilityBoundingSet=~CAP_BLOCK_SUSPENDÂ Â Â Â Â Service may establish wake locks                                             0.1<br>
âœ— CapabilityBoundingSet=~CAP_LEASEÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may create file leases                                               0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYS_PACCTÂ Â Â Â Â Â Â Â Â Service may use acct()                                                       0.1<br>
âœ— CapabilityBoundingSet=~CAP_SYS_TTY_CONFIGÂ Â Â Â Service may issue vhangup()                                                  0.1<br>
âœ— CapabilityBoundingSet=~CAP_WAKE_ALARMÂ Â Â Â Â Â Â Â Service may program timers that wake up the system                           0.1<br>
âœ— RestrictAddressFamilies=~AF_UNIXÂ Â Â Â Â Â Â Â Â Â Â Â Â Service may allocate local sockets                                           0.1</p>
<p>â†’ <strong>Overall exposure level for cups.service: 9.6 UNSAFE ğŸ˜¨</strong></p>
</blockquote>
<p>Podemos ver que se trata de um checklist onde temos quatro colunas: A primeira coluna (quase invisÃ­vel), mostra se o item estÃ¡
presente ou ausente, ou seja, se passou ou nÃ£o. A segunda coluna corresponde ao nome da diretiva de configuraÃ§Ã£o, mais detalhes a seguir. A terceira
coluna dÃ¡ uma descriÃ§Ã£o sucinta da configuraÃ§Ã£o que deveria ser evitada. A quarta coluna dÃ¡ grau de exposiÃ§Ã£o correspondente Ã  ausÃªncia
deste item de configuraÃ§Ã£o. O valor corresponde a um peso ajustado de acordo com o grau de comprometimento de seguranÃ§a que pode provocar.
A interpretaÃ§Ã£o do cÃ¡lculo Ã© de que o sistema inicia com o valor de 10(dez) e cada item configurado corretamente tem o seu peso associado
decrementado e um Ã­cone de seta na primeira coluna apontando esse item como OK.</p>
<p>Como mencionado, cada item desse relatÃ³rio corresponde a uma diretiva especÃ­fica no arquivo de configuraÃ§Ã£o da Unit.</p>
<p>No primeiro relatÃ³rio, vÃ¡rios serviÃ§os sÃ£o marcados como inseguros (UNSAFE). Isso acontece por que nem todas as aplicaÃ§Ãµes usam
as funcionalidades fornecidas pelo SystemD.</p>
<p>A quantidade de serviÃ§os marcados como inseguros certamente vai assustar quem o vir pela primeira vez, por isso Ã© necessÃ¡rio
entender que a mÃ©trica Ã© calculada indistintamente para todos os serviÃ§os, ou seja, tanto um servidor web quanto o plymouth, que mostra
a logomarca da distribuiÃ§Ã£o no inÃ­cio do boot, por exemplo, sÃ£o avaliados.</p>
<p>Portanto pode ser custoso conduzir todos os serviÃ§os chegarem Ã  avaliaÃ§Ã£o OK. Ã‰ necessÃ¡rio, entÃ£o, algum mÃ©todo que permita
alcanÃ§ar a mÃ¡xima seguranÃ§a com o mÃ­nimo de esforÃ§o.</p>
<p>EntÃ£o, deverÃ­amos comeÃ§ar analizando os serviÃ§os que estejam expostos Ã  Internet ou processem dados nÃ£o confiÃ¡veis que possam
ser fornecidos pelo usuÃ¡rio, como servidores Web, servidores de bancos de dados, servidores de VPN entre outros.</p>
<p>Sem mencionar, Ã© claro, os serviÃ§os que nem deveriam estar habilitados num servidor, como wpa_supplicant e lightdm entre outros.
Cada um uma possÃ­vel porta de entrada para um invador.</p>
<h2 id="protegendo">Protegendo</h2>
<p>Agora, dado que obtivemos uma avaliaÃ§Ã£o da seguranÃ§a do nosso sistema sob o ponto de vista do SystemD, como podemos melhorar?</p>
<p>Systemd permite que os serviÃ§os(Unit) rodem dentro de um ambiente protegido (uma &ldquo;sandbox&rdquo;) fornecidos pelo kernel Linux. Quem pensou
num contÃ¢iner quase acertou.</p>
<p>Assim como um contÃ¢iner, o kernel Linux pode filtrar e limitar acesso a sistemas de arquivos, redes e dispositivos entre outras
coisas. Ou seja, permite isolar um serviÃ§o do restante do sistema usando namespaces dentro do espaÃ§o do kernel.</p>
<p>Para ajustar a seguranÃ§a de um serviÃ§o devemos adotar uma estratÃ©gia incremental. Ativar um item de configuraÃ§Ã£o, recarregar o serviÃ§o, ver se tudo continua
funcionando conforme o esperado e seguir para o prÃ³ximo item atÃ© alcanÃ§ar uma nÃ­vel de seguranÃ§a considerado aceitÃ¡vel.</p>
<p>Como exemplo, vamos considerar o serviÃ§o do cups do Ãºltimo relatÃ³rio e configurar algumas coisas para aumentar sua proteÃ§Ã£o.</p>
<p>Para o artigo nÃ£o ficar muito longo vou configurar somente algumas diretivas.</p>
<p>SÃ£o as que eu considero essenciais, mas nÃ£o entenda como um ajuste exaustivo. Para mais detalhes siga as referÃªncias no final.</p>
<h3 id="1---evitar-que-um-atacante-escale-privilÃ©gios">1 - Evitar que um atacante escale privilÃ©gios</h3>
<p>Se um atacante explorar alguma vulnerabilidade, eu nÃ£o quero que ele se torne root, pois uma vez alcanÃ§ado o acesso root Ã© fim de jogo.</p>
<p>Para comeÃ§ar vamos recordar nosso grau de exposiÃ§Ã£o:</p>
<blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>9.6 UNSAFE</strong> ğŸ˜¨</p>
</blockquote>
<p>A Unit do cups estÃ¡ em /usr/lib/systemd/system/cups.service. O conteÃºdo atual Ã© o seguinte:</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>Vamos adicionar a diretiva <strong>NoNewPrivileges=true</strong> dentro da seÃ§Ã£o <strong>[Service]</strong>. Vai ficar assim:</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>Recarregamos todos os serviÃ§os:</p>
<blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>sudo systemctl daemon-reload</strong></p>
</blockquote>
<p>E verificamos o grau de exposiÃ§Ã£o:</p>
<blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>9.4 UNSAFE</strong> ğŸ˜¨</p>
</blockquote>
<p>Veja que uma grande proteÃ§Ã£o diminuiu muito pouco, mas jÃ¡ Ã© um comeÃ§o. Uma outra estratÃ©gia poderia ser verificar quais fatores possuem
os maiores graus de exposiÃ§Ã£o e comeÃ§ar por eles.</p>
<h3 id="2--evite-gente-xeretando-o-tmp">2- Evite gente xeretando o /tmp</h3>
<p>Uma vez tendo explorada uma vulnerabilidade eu nÃ£o quero que um atacante possa ver acesso a dados de outros processos. VÃ¡rios aplicativos
criam arquivos temporÃ¡rios durante seu tempo de existÃªncia e o lugar padrÃ£o para eles Ã© o diretÃ³rio /tmp do sistema.</p>
<p>Voltamos ao arquivo <strong>/usr/lib/systemd/system/cups.service</strong>  e vamos adicionar a diretiva <strong>PrivateTmp=yes</strong>. Vai ficar assim:</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>sudo systemctl daemon-reload</strong><br>
leandro@leandro:/usr/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>9.0 UNSAFE</strong> ğŸ˜¨</p>
</blockquote>
<p>Veja que eliminamos dois problemas, mas o systemD nÃ£o ligou a mÃ­nima! Ainda estamos com um nÃ­vel insatisfatÃ³rio de seguranÃ§a.</p>
<h3 id="3---torne-variÃ¡veis-do-kernel-somente-leitura">3 - Torne variÃ¡veis do kernel somente leitura</h3>
<p>Agora seguiremos para configuraÃ§Ãµes mais sutis.</p>
<p>Uma vez que um atacante alcanÃ§a o sistema, a primeira coisa que ele farÃ¡ serÃ¡ tentar garantir que vai continuar acessando o sistema.</p>
<p>Ele pode conseguir isso de diversas maneiras e uma delas Ã© modificar o sistema. Em particular, um atacante nÃ£o deve ser capaz
de carregar mÃ³dulos de kernel, os chamados rootkits, nem modificar parÃ¢metros de configuraÃ§Ã£o, principalmente subsistemas como acpi entre outros.</p>
<p>Por isso vamos adicionar as diretivas <strong>ProtectKernelTunables=yes</strong>, <strong>ProtectKernelModules=yes</strong>, <strong>ProtectControlGroups=yes</strong>, como abaixo:</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>E verificar o impacto:</p>
<blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>8.3 EXPOSED</strong> ğŸ™</p>
</blockquote>
<p>Estamos abaixo de 9 pela primeira vez, e protegemos o sistema de trÃªs problemas, mesmo assim nossa avaliaÃ§Ã£o ainda nÃ£o Ã© boa!</p>
<h3 id="4---montar-diretÃ³rio-usr-boot-bootefi-e-etc-como-somente-leitura">4 - Montar diretÃ³rio /usr, /boot, /boot/efi e /etc como somente leitura</h3>
<p>Novamente a lÃ³gica Ã© de que um atacante nÃ£o pode modificar o sistema em caso de sucesso. Queremos impedir que ele modifique o binÃ¡rio
de algum aplicativo inserindo uma versÃ£o maliciosa e que ele possa inserir um aplicativo efi de boot (como um grub malicioso, por exemplo). AlÃ©m
disso, devemos proteger o diretÃ³rio /etc de modificaÃ§Ãµes visto que ele contÃ©m as configuraÃ§Ãµes do sistema.</p>
<p>Vamos adicionar a diretiva <strong>ProtectSystem=full</strong>.</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectSystem=full

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>E vericar o resultado:</p>
<blockquote>
<p>leandro@leandro:/usr/lib/systemd/system$ <strong>sudo systemctl daemon-reload</strong><br>
leandro@leandro:/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>8.2 EXPOSED</strong> ğŸ™</p>
</blockquote>
<p>Uma coisa a ser mencionada Ã© que essa configuraÃ§Ã£o Ã© para a Unit, ou seja, apenas a Unit enxerga esses diretÃ³rios como somente leitura e
Ã© importante destacar essa informaÃ§Ã£o.</p>
<p>Como eu falei, essa defesa funciona em camadas, mas o systemD nÃ£o Ã© infalÃ­vel e devemos configurar nossa mÃ¡quina de modo a proteger
esses diretÃ³rios independente do init utilizado(adicionar mais uma camada).</p>
<h3 id="5---excluir-namespaces-que-o-serviÃ§o-nÃ£o-esteja-utilizando">5 - Excluir namespaces que o serviÃ§o nÃ£o esteja utilizando</h3>
<p>Eu me concentro nos problemas anteriores, a partir daqui o SystemD nos ajuda a nos proteger de problemas que nem sequer sabÃ­amos
que estÃ¡vamos expostos(pelo menos Ã© o meu caso).</p>
<p>Agora vamos restringir nosso serviÃ§o de modo que ele acesse apenas o que precise para funcionar em termos de recursos de sistema como
interfaces de rede, comunicaÃ§Ã£o inter processos entre outros. Eu vou configurar a diretiva <strong>RestrictNamespaces</strong> e dizer que meu serviÃ§o
cups sÃ³ vai poder usar a interface de rede, mais nada. Por isso a lista de itens <strong>uts</strong>, <strong>ipc</strong>, <strong>pid</strong>, <strong>user</strong>, <strong>cgroup</strong></p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectSystem=full
RestrictNamespaces=uts ipc pid user cgroup

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>E novamente verificar o impacto:</p>
<blockquote>
<p>leandro@leandro:/lib/systemd/system$ <strong>sudo systemctl daemon-reload</strong><br>
leandro@leandro:/lib/systemd/system$ <strong>systemd-analyze security cups &ndash;no-pager| grep exposure</strong><br>
â†’ Overall exposure level for cups.service: <strong>8.0 EXPOSED</strong> ğŸ™</p>
</blockquote>
<h3 id="6---limitar-as-capacidades">6 - Limitar as capacidades</h3>
<p>Capacidade aqui significa o que um processo com nÃ­vel nÃ£o privilegiado pode fazer. NÃ£o Ã© possÃ­vel explicar em pormenores cada configuraÃ§Ã£o,
mas para mais detalhes acesse a manpage - <strong>man capabilities</strong> na linha de comando.</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectSystem=full
RestrictNamespaces=uts ipc pid user cgroup
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_DAC_READ_SEARCH

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>Acima permitimos que o serviÃ§o rode em uma porta privilegiada.</p>
<blockquote>
<p>leandro@leandro:/lib/systemd/system$ sudo systemctl daemon-reload<br>
leandro@leandro:/lib/systemd/system$ systemd-analyze security cups &ndash;no-pager| grep exposure<br>
â†’ Overall exposure level for cups.service: <strong>5.9 MEDIUM</strong> ğŸ˜</p>
</blockquote>
<p>Finalmente conseguimos uma carinha indiferente, o que jÃ¡ Ã© uma vitÃ³ria.</p>
<h3 id="7---criar-um-dispositivo-de-rede-para-a-unit">7 - Criar um dispositivo de rede para a Unit</h3>
<p>Aqui a ideia Ã© a mesma de um contÃ¢iner e isolar o serviÃ§o do restante do sistema. Para isso vamos setar <strong>PrivateNetwork=true</strong></p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectSystem=full
RestrictNamespaces=uts ipc pid user cgroup
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_DAC_READ_SEARCH
PrivateNetwork=true

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>E verificar o impacto:</p>
<blockquote>
<p>leandro@leandro:/lib/systemd/system$ sudo systemctl daemon-reload<br>
leandro@leandro:/lib/systemd/system$ systemd-analyze security cups &ndash;no-pager| grep exposure<br>
â†’ Overall exposure level for cups.service: 5.5 MEDIUM ğŸ˜</p>
</blockquote>
<p>Tivemos algum trabalho, mais ainda temos uma carinha indiferente e uma avaliaÃ§Ã£o de 5.5! Mas para mim chega, jÃ¡ estou satisfeito
com as configuraÃ§Ãµes que eu fiz. Ã‰ claro que um serviÃ§o exposto Ã  Internet requereria mais algum esforÃ§o, mas para este artigo jÃ¡ estÃ¡
bom.</p>
<h3 id="um-alerta">Um alerta</h3>
<p>Algumas configuraÃ§Ãµes podem provocar erro, por isso Ã© necessÃ¡rio adotar uma estratÃ©gia passo a passo.</p>
<p>Por exemplo, adicionando a diretiva <strong>DynamicUser=true</strong> poderÃ­amos permitir que o sistema criasse um &ldquo;usuÃ¡rio efÃªmerero&rdquo; para o serviÃ§o.</p>
<p>Um usuÃ¡rio efÃªmero Ã© um usuÃ¡rio exclusivo para rodar serviÃ§os e que nÃ£o vai ter login nem acesso a shell, como o usuÃ¡rio <strong>nobody</strong> em muitos sistemas.</p>
<p>Abaixo a configuraÃ§Ã£o:</p>
<pre><code>[Unit]
Description=CUPS Scheduler
Documentation=man:cupsd(8)
After=sssd.service
Requires=cups.socket

[Service]
ExecStart=/usr/sbin/cupsd -l
Type=simple
Restart=on-failure
NoNewPrivileges=true
PrivateTmp=yes
ProtectKernelTunables=yes
ProtectKernelModules=yes
ProtectControlGroups=yes
ProtectSystem=full
RestrictNamespaces=uts ipc pid user cgroup
CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_DAC_READ_SEARCH
PrivateNetwork=true
DynamicUser=true

[Install]
Also=cups.socket cups.path
WantedBy=printer.target
</code></pre><p>PorÃ©m, se recarregarmos o serviÃ§o:</p>
<blockquote>
<p>leandro@leandro:/lib/systemd/system$ sudo systemctl daemon-reload</p>
</blockquote>
<p>E checarmos o status, veremos que temos problema:</p>
<blockquote>
<p>leandro@leandro:/lib/systemd/system$ systemctl status cups.service<br>
â— cups.service - CUPS Scheduler<br>
Â Â      Loaded: loaded (/lib/systemd/system/cups.service; enabled; vendor preset: enabled)<br>
Â Â      Active: active (running) since Tue 2022-09-13 23:27:05 -03; 2min 28s ago<br>
TriggeredBy: â— cups.path<br>
Â Â              â— cups.socket<br>
Â Â        Docs: man:cupsd(8)<br>
Â    Main PID: 8329 (cupsd)<br>
Â Â       Tasks: 1 (limit: 4488)<br>
Â  Â     Memory: 1.7M<br>
Â Â      CGroup: /system.slice/cups.service<br>
Â Â              â””â”€8329 /usr/sbin/cupsd -l</p>
<p>set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to change permissions of &ldquo;/var/log/cups&rdquo; - Read-only file system</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to open log file &ldquo;/var/log/cups/error_log&rdquo; - Permission denied</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to change permissions of &ldquo;/var/log/cups&rdquo; - Read-only file system</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to open log file &ldquo;/var/log/cups/error_log&rdquo; - Permission denied</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to change permissions of &ldquo;/var/log/cups&rdquo; - Read-only file system</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to open log file &ldquo;/var/log/cups/access_log&rdquo; - Permission denied</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to change permissions of &ldquo;/var/log/cups&rdquo; - Read-only file system</strong><br>
set 13 23:27:05 leandro cupsd[8329]: <strong>Unable to open log file &ldquo;/var/log/cups/access_log&rdquo; - Permission denied</strong><br>
set 13 23:27:37 leandro cupsd[8329]: <strong>Unable to change permissions of &ldquo;/var/log/cups&rdquo; - Read-only file system</strong><br>
set 13 23:27:37 leandro cupsd[8329]: <strong>Unable to open log file &ldquo;/var/log/cups/error_log&rdquo; - Permission denied</strong></p>
</blockquote>
<p>Nossa alteraÃ§Ã£o provocou problemas no permissionamento. Por isso precisamos desfazer o que fizemos.</p>
<p>Ã‰ bom lembrar que nÃ³s nÃ£o precisamos chegar a um valor de zero para todo serviÃ§o. O que Ã© importante Ã© implementarmos as proteÃ§Ãµes que nos deixem
tranquilos quanto Ã  seguranÃ§a do serviÃ§o e do sistema como um todo.</p>
<p>Por isso vou parar por aqui. Conseguimos passar nosso grau de exposiÃ§Ã£o de 9.6 para 5.5 - quase metade!</p>
<h2 id="conclusÃ£o">ConclusÃ£o</h2>
<p>O tÃ£o mal falado quanto incompreendido SystemD fornece uma sÃ©rie de ferramentas que auxiliam o administrador de sistemas Linux.</p>
<p>Uma delas Ã© o systemd-analyze, que alÃ©m de fornecer dados sobre o carregamento do sistema, fornece tambÃ©m subsÃ­dios para auditar a
seguranÃ§a dos serviÃ§os executados.</p>
<p>O sub comando security vem com uma mÃ©trica para calcular a seguranÃ§a, permitindo saber se um serviÃ§o estÃ¡ seguro em
termo de configuraÃ§Ã£o da Unit e vem tambÃ©m com um checklist com itens para melhorar a proteÃ§Ã£o usando uma estratÃ©gia passo a passo, encapsulando cada serviÃ§o ao mÃ¡ximo
como um verdadeiro contÃ¢iner sem <strong>Docker</strong>.</p>
<p>E o melhor de tudo Ã© que a cada passo Ã© possÃ­vel explicar o que estÃ¡ sendo feito e como estÃ¡ sendo feito!</p>
<p>Isso permite que, se um atacante for capaz de burlar a configuraÃ§Ã£o de um serviÃ§o ou explorar uma falha de codificaÃ§Ã£o, nÃ£o seja
capaz de ir alÃ©m dos limites que lhe impusermos, da mesma forma que, para proteger uma casa, adicionamos um muro, depois colocamos cÃ£es
de guarda, em seguida colocamos grades nas janelas e cadeados nas portas.</p>
<p>Um nÃ­vel impedindo um agressor de prosseguir para o seguinte!</p>
<h3 id="fontes">Fontes:</h3>
<p><a href="https://lincolnloop.com/blog/sandboxing-services-systemd/">https://lincolnloop.com/blog/sandboxing-services-systemd/</a></p>
<p><a href="https://www.freedesktop.org/software/systemd/man/systemd.exec.html">https://www.freedesktop.org/software/systemd/man/systemd.exec.html</a></p>
<p><a href="https://www.ctrl.blog/entry/systemd-service-hardening.html">https://www.ctrl.blog/entry/systemd-service-hardening.html</a></p>
<p><a href="https://www.admin-magazine.com/Archive/2022/67/Harden-services-with-systemd">https://www.admin-magazine.com/Archive/2022/67/Harden-services-with-systemd</a></p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/ubuntu/" rel="tag">ubuntu</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/linux/" rel="tag">linux</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/systemd/" rel="tag">systemD</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Leandro PeÃ§anha Scardua avatar" src="/img/avatar.png" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">Sobre Leandro PeÃ§anha Scardua</span>
	</div>
	<div class="authorbox__description">
		Desenvolvedor e entusiasta de Software Livre
	</div>
</div>

<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/artigos/a-saga-do-tablet-04/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Anterior</span>
			<p class="pager__title">A saga do Tablet - parte 04</p>
		</a>
	</div>
</nav>



		</div>
		
	</div>
	<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2022 Leandro PeÃ§anha Scardua.
			<span class="footer__copyright-credits">Gerado com <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> com o tema <a href="https://github.com/pfadfinder-konstanz/hugo-dpsg/" rel="nofollow noopener" target="_blank">DPSG</a>.</span>
			
		</div>
		

	</div>
</footer>

	<script async defer src="/js/menu.js"></script>
	<script src="/js/custom.js"></script>
	
	
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2217338589613653"
     crossorigin="anonymous"></script>
</body>
</html>
